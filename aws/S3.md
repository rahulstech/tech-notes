## AWS S3 Lessons Learned

### Introduction

Amazon Simple Storage Service (S3) is a highly scalable, durable, and secure object storage service offered by AWS, designed to store and retrieve any amount of data at any time from anywhere on the web. It provides 99.999999999% (11 9's) durability and 99.99% availability, making it suitable for a wide range of use cases like backups, archiving, big data analytics, and media hosting. With features like versioning, encryption, and replication, S3 ensures data integrity and accessibility while integrating seamlessly with other AWS services.

This document summarizes key concepts and configurations for Amazon S3 (Simple Storage Service) based on hands-on exploration. Topics covered include versioning, object locking, ownership/ACLs, encryption, access points, access logs, replication, and CLI commands. **Note on Lifecycle Management**: This topic is partially noted below but not fully explored yet—details on auto-expiration, storage class transitions, and rules based on days elapsed, prefixes, suffixes, or tags will be added later.

### Versioning

- **Enabling Versioning**: Navigate to bucket Properties > Enable > Save. Versioning applies to the entire bucket (not by prefix, suffix, etc.).
- **Pre-Versioning Objects**: Objects created before versioning is enabled receive a `null` version ID.
- **Delete Markers**: 
  - A delete marker is a placeholder with the latest version ID, allowing bucket listings to skip "deleted" objects.
  - To restore a "deleted" object: Delete the delete marker by specifying its version ID.
  - Deleting an object without a version ID adds a delete marker (hides the latest version).
  - Deleting with a specific version ID removes only that version, leaving others intact.
- **Lifecycle Integration**: Add a lifecycle rule to automatically delete objects when a delete marker is set (i.e., when it's the latest version).

### Object Locking

- **WORM (Write Once, Read Many)**: Once enabled on a bucket, it cannot be disabled.
- **Retention Modes**:
  - **Disabled**: Objects can never be deleted or modified.
  - **Enabled**:
    - **Governance Mode**: Deletion/modification requires specific IAM permission (`s3:BypassGovernanceRetention`).
    - **Compliance Mode**: Deletion/modification is only possible after the retention period expires.
- **Applicability**: Works only for objects/versions created *after* locking is enabled or when explicitly set. Older objects/versions can still be deleted/modified normally.
- **Interaction with Versioning**: 
  - Deleting an object (with versioning + locking enabled) creates a delete marker.
  - Delete markers can be deleted without issues, but locked actual objects/versions cannot be deleted.

### Ownership and ACLs

- **Access Control Lists (ACLs)**: 
  - Oldest method for controlling object read/write permissions; disabled by default.
  - Default: Full control to the bucket owner.
  - Manages access for public, log delivery groups, or other AWS accounts.
  - **Recommendation**: Use IAM policies and bucket policies instead—these are modern and preferred.
- **Ownership Controls**:
  - Determines ownership of bucket objects, especially when uploaded from different AWS accounts.
  - **BucketOwnerEnforced** (default): Bucket owner controls all objects, regardless of uploader.
  - **ObjectWriter**: Uploader's account owns the object. Bucket owner needs ACL granting `FullControl` to write.
- **Key Distinction**: AWS Account vs. IAM User—ownership refers to the account level (users inherit unless restricted).

### Encryption

**Server-Side Encryption (SSE)**
- **S3-Managed Keys (SSE-S3)**: Free; S3 handles encryption/decryption with AES-256.
- **AWS KMS Keys (SSE-KMS)**: Uses KMS for key management; incurs extra costs for key retrieval API calls and storage.
- **Customer-Provided Keys (SSE-C)**: Client provides encryption key in headers; raw object is sent, and S3 encrypts it.
- **Enforcement via Bucket Policy**: Require encryption headers in PUT requests. Example policy to deny unencrypted PUTs using KMS:

  ```json
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Deny",
        "Principal": "*",
        "Resource": "<s3-bucket-arn-for-objects>",
        "Action": ["s3:PutObject"],
        "Condition": {
          "StringNotEquals": {
            "s3:x-amz-server-side-encryption": "aws:kms"
          }
        }
      }
    ]
  }
  ```

- **Headers for PUT Requests**:
  - `x-amz-server-side-encryption: AES256` (for SSE-S3).
  - `x-amz-server-side-encryption: aws:kms` (for SSE-KMS).

**Client-Side Encryption (CSE)**
- Client fully handles encryption before upload and decryption after download.

**S3 Bucket Keys (for SSE-KMS)**
- **Purpose**: Reduces KMS API call costs for high-volume read/write operations.
- **How It Works**:
  - S3 caches a short-lived bucket-level key.
  - This generates per-object Data Encryption Keys (DEKs).
  - DEKs encrypt/decrypt the objects.
- **Logging Notes**:
  - Bucket key creation/decryption is logged in CloudTrail.
  - Individual DEK operations are *not* logged (to save costs/complexity).
  - If policy requires logging every DEK operation, avoid bucket keys.
- **Key Generation**:
  - Without bucket keys: KMS generates/encrypts DEKs directly.
  - With bucket keys: S3 derives DEKs from the cached key (KMS only handles the bucket key).

### Access Points

- **Use Case**: For buckets with segmented data (e.g., `/analytics/` for internal teams, `/mobile-data/` for public access). Create access points per segment for fine-grained control.
- **Features**:
  - Define policies for IAM roles/services.
  - Restrict network origins (e.g., VPC-only access to block public exposure).
  - Block public access per access point.
  - Use access point aliases for simplified access.
- **ARN Format**: `arn:aws:s3:<region>:<account-id>:accesspoint/<access-point-name>/object/<key>`.
- **Example Policy** (Allow analytics team read access):

  ```json
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Sid": "AllowAnalyticsTeamRead",
        "Effect": "Allow",
        "Principal": { "AWS": "arn:aws:iam::111122223333:role/AnalyticsTeamRole" },
        "Action": ["s3:GetObject"],
        "Resource": "arn:aws:s3:us-east-1:111122223333:accesspoint/analytics-ap/object/analytics/*"
      }
    ]
  }
  ```

### Access Logs

- **Purpose**: Log all successful/unsuccessful access attempts to a target bucket.
- **Requirements**: Log bucket must be in the same AWS account and region as the target.

### Replication

- **Overview**: Asynchronously copies objects between buckets (same/different regions/accounts).
  - Enable versioning and object locking on the destination if needed.
- **Types**:
  - **Cross-Region Replication (CRR)**: For cross-region copies.
  - **Same-Region Replication (SRR)**: For intra-region copies.
- **Configuration**:
  - Uses an IAM role (auto-created if none exists).
  - Add replication ID and priority (higher priority rules apply first for overlapping objects).
  - Options:
    - Copy SSE-KMS encryption (replicas use S3-managed keys only).
    - Match storage class of source.
    - Enable Replication Time Control (RTC) for <15-min sync.
    - Replicate metadata changes (syncs updates from destination to source).
    - Replicate delete markers.
    - Monitor via replication metrics.
- **Notes**:
  - Existing objects aren't replicated automatically—use S3 Batch Operations for backfill.

### CLI Commands

**Versioning and Object Inspection**
```bash
# List all versions of an object
aws s3api list-object-versions --bucket <bucket-name> --prefix <the-object-key>

# Get retention for a specific object
aws s3api get-object-retention --bucket <bucket-name> --key <object-key>

# Get bucket-level object lock configuration
aws s3api get-object-lock-configuration --bucket <bucket-name>
```

**Basic Bucket/Object Operations (LocalStack Example)**
```bash
# Use LocalStack endpoint
aws s3 --endpoint-url http://localhost:4566 --region ap-south-1 \
  cp <local-file> s3://<bucket>/<key>  # Upload object

aws s3 --endpoint-url http://localhost:4566 --region ap-south-1 \
  rm s3://<bucket>/<key>  # Delete object

aws s3 --endpoint-url http://localhost:4566 --region ap-south-1 \
  ls s3://<bucket>/[<key>]  # List bucket contents or prefixed objects

# Get object metadata (HEAD)
aws s3api head-object --endpoint-url http://localhost:4566 --region ap-south-1 \
  --bucket <bucket> --key <key>
```

**Bucket Management**
```bash
# List all buckets
aws s3api --endpoint-url http://localhost:4566 list-buckets --query "Buckets[].Name" --output text

# Create bucket
aws s3 --endpoint-url http://localhost:4566 mb s3://demo-bucket

# List bucket contents
aws s3 --endpoint-url http://localhost:4566 ls s3://demo-bucket

# Delete bucket
aws s3 --endpoint-url http://localhost:4566 rb s3://demo-bucket

# Upload example
aws s3 --endpoint-url http://localhost:4566 cp ./me.jpeg s3://demo-bucket/me.jpeg
```

**Notifications**
```bash
# Put bucket notification configuration (e.g., to SQS on object creation with prefix)
aws s3api --endpoint-url http://localhost:4566 put-bucket-notification-configuration \
  --bucket demo-bucket \
  --notification-configuration '{
    "QueueConfigurations": [
      {
        "QueueArn": "arn:aws:sqs:ap-south-1:000000000000:demo-queue",
        "Events": ["s3:ObjectCreated:Put"],
        "Filter": {
          "Key": {
            "FilterRules": [
              {
                "Name": "prefix",
                "Value": "medias/"
              }
            ]
          }
        }
      }
    ]
  }'

# Get bucket notification configuration
aws s3api --endpoint-url http://localhost:4566 get-bucket-notification-configuration --bucket demo-bucket

# Get bucket policy
aws s3api --endpoint-url http://localhost:4566 --region ap-south-1 get-bucket-policy --bucket demo-bucket
```

### Next Steps
- Dive deeper into Lifecycle Management rules.
- Explore S3 Batch Operations for large-scale tasks.
- Test integration with IAM policies and VPC endpoints.

*Last Updated: October 29, 2025*
